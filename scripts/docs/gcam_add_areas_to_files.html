<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GCAM Add Areas to Files Script Documentation</title>
    <style>
/* 
 * Documentation Stylesheet for GCAM Synthetic Data Generation Script
 * A modern, colorful design with good readability
 */

/* ===== ROOT VARIABLES ===== */
:root {
    /* Color Palette */
    --primary-blue: #2563eb;
    --primary-blue-light: #3b82f6;
    --primary-blue-dark: #1e40af;
    --accent-green: #10b981;
    --accent-orange: #f59e0b;
    --accent-purple: #8b5cf6;
    --accent-red: #ef4444;
    
    /* Background Colors */
    --bg-main: #f8fafc;
    --bg-code: #1e293b;
    --bg-code-inline: #e2e8f0;
    --bg-table-header: #1e40af;
    --bg-table-row-even: #f1f5f9;
    --bg-table-row-odd: #ffffff;
    --bg-note: #fef3c7;
    --bg-warning: #fee2e2;
    --bg-info: #dbeafe;
    --bg-success: #d1fae5;
    
    /* Text Colors */
    --text-main: #1e293b;
    --text-secondary: #64748b;
    --text-code: #e2e8f0;
    --text-link: #2563eb;
    --text-link-hover: #1e40af;
    
    /* Border Colors */
    --border-light: #e2e8f0;
    --border-medium: #cbd5e1;
    --border-dark: #94a3b8;
    
    /* Spacing */
    --spacing-xs: 0.25rem;
    --spacing-sm: 0.5rem;
    --spacing-md: 1rem;
    --spacing-lg: 1.5rem;
    --spacing-xl: 2rem;
    --spacing-2xl: 3rem;
}

/* ===== BASE STYLES ===== */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.7;
    color: var(--text-main);
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: var(--spacing-xl) var(--spacing-md);
    font-size: 16px;
}

/* Main Container */
.container {
    max-width: 1200px;
    margin: 0 auto;
    background: var(--bg-main);
    padding: var(--spacing-2xl);
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

/* ===== TYPOGRAPHY ===== */
h1 {
    font-size: 2.5rem;
    color: var(--primary-blue-dark);
    margin-bottom: var(--spacing-xl);
    padding-bottom: var(--spacing-md);
    border-bottom: 4px solid var(--primary-blue);
    font-weight: 700;
    background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-purple) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

h2 {
    font-size: 2rem;
    color: var(--primary-blue);
    margin-top: var(--spacing-2xl);
    margin-bottom: var(--spacing-lg);
    padding-left: var(--spacing-md);
    border-left: 5px solid var(--accent-green);
    font-weight: 600;
}

h3 {
    font-size: 1.5rem;
    color: var(--primary-blue-dark);
    margin-top: var(--spacing-xl);
    margin-bottom: var(--spacing-md);
    font-weight: 600;
    display: flex;
    align-items: center;
}

h3::before {
    content: "▸";
    color: var(--accent-orange);
    margin-right: var(--spacing-sm);
    font-size: 1.2rem;
}

h4 {
    font-size: 1.25rem;
    color: var(--accent-purple);
    margin-top: var(--spacing-lg);
    margin-bottom: var(--spacing-sm);
    font-weight: 600;
}

p {
    margin-bottom: var(--spacing-md);
    color: var(--text-main);
}

/* ===== LINKS ===== */
a {
    color: var(--text-link);
    text-decoration: none;
    font-weight: 500;
    border-bottom: 2px solid transparent;
    transition: all 0.3s ease;
}

a:hover {
    color: var(--text-link-hover);
    border-bottom-color: var(--text-link-hover);
}

/* ===== LISTS ===== */
ul, ol {
    margin-left: var(--spacing-xl);
    margin-bottom: var(--spacing-md);
}

li {
    margin-bottom: var(--spacing-sm);
    padding-left: var(--spacing-sm);
}

ul li::marker {
    color: var(--accent-green);
    font-size: 1.2em;
}

ol li::marker {
    color: var(--primary-blue);
    font-weight: 600;
}

/* ===== CODE BLOCKS ===== */
code {
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 0.9em;
    padding: var(--spacing-xs) var(--spacing-sm);
    background: var(--bg-code-inline);
    color: var(--accent-red);
    border-radius: 4px;
    font-weight: 500;
}

pre {
    background: var(--bg-code);
    color: var(--text-code);
    padding: var(--spacing-lg);
    border-radius: 8px;
    overflow-x: auto;
    margin: var(--spacing-lg) 0;
    border-left: 4px solid var(--accent-green);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

pre code {
    background: transparent;
    color: var(--text-code);
    padding: 0;
    font-size: 0.95em;
    line-height: 1.5;
}

/* ===== TABLES ===== */
table {
    width: 100%;
    border-collapse: collapse;
    margin: var(--spacing-xl) 0;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

thead {
    background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-dark) 100%);
    color: white;
}

th {
    padding: var(--spacing-md);
    text-align: left;
    font-weight: 600;
    font-size: 1.05em;
    border-bottom: 3px solid var(--accent-orange);
}

td {
    padding: var(--spacing-md);
    border-bottom: 1px solid var(--border-light);
}

tbody tr:nth-child(even) {
    background: var(--bg-table-row-even);
}

tbody tr:nth-child(odd) {
    background: var(--bg-table-row-odd);
}

tbody tr:hover {
    background: #e0f2fe;
    transform: scale(1.01);
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

/* ===== BLOCKQUOTES ===== */
blockquote {
    margin: var(--spacing-lg) 0;
    padding: var(--spacing-md) var(--spacing-lg);
    background: var(--bg-info);
    border-left: 5px solid var(--primary-blue);
    border-radius: 0 8px 8px 0;
    font-style: italic;
    color: var(--primary-blue-dark);
}

/* ===== HORIZONTAL RULES ===== */
hr {
    border: none;
    height: 3px;
    background: linear-gradient(90deg, var(--accent-green) 0%, var(--primary-blue) 50%, var(--accent-purple) 100%);
    margin: var(--spacing-2xl) 0;
    border-radius: 2px;
}

/* ===== SPECIAL BOXES ===== */
.note {
    background: var(--bg-note);
    border-left: 5px solid var(--accent-orange);
    padding: var(--spacing-md) var(--spacing-lg);
    margin: var(--spacing-lg) 0;
    border-radius: 0 8px 8px 0;
}

.warning {
    background: var(--bg-warning);
    border-left: 5px solid var(--accent-red);
    padding: var(--spacing-md) var(--spacing-lg);
    margin: var(--spacing-lg) 0;
    border-radius: 0 8px 8px 0;
}

.info {
    background: var(--bg-info);
    border-left: 5px solid var(--primary-blue);
    padding: var(--spacing-md) var(--spacing-lg);
    margin: var(--spacing-lg) 0;
    border-radius: 0 8px 8px 0;
}

.success {
    background: var(--bg-success);
    border-left: 5px solid var(--accent-green);
    padding: var(--spacing-md) var(--spacing-lg);
    margin: var(--spacing-lg) 0;
    border-radius: 0 8px 8px 0;
}

/* ===== BADGES ===== */
.badge {
    display: inline-block;
    padding: var(--spacing-xs) var(--spacing-md);
    border-radius: 20px;
    font-size: 0.85em;
    font-weight: 600;
    margin: 0 var(--spacing-xs);
}

.badge-required {
    background: var(--accent-red);
    color: white;
}

.badge-optional {
    background: var(--accent-green);
    color: white;
}

.badge-default {
    background: var(--primary-blue);
    color: white;
}

/* ===== STRONG & EM ===== */
strong {
    color: var(--primary-blue-dark);
    font-weight: 700;
}

em {
    color: var(--accent-purple);
    font-style: italic;
}

/* ===== IMAGES ===== */
img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin: var(--spacing-lg) 0;
}

/* ===== SCROLLBAR STYLING ===== */
::-webkit-scrollbar {
    width: 12px;
    height: 12px;
}

::-webkit-scrollbar-track {
    background: var(--bg-table-row-even);
    border-radius: 10px;
}

::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-purple) 100%);
    border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, var(--primary-blue-dark) 0%, var(--accent-purple) 100%);
}

/* ===== PRINT STYLES ===== */
@media print {
    body {
        background: white;
        padding: 0;
    }
    
    .container {
        box-shadow: none;
        max-width: 100%;
    }
    
    h1, h2, h3 {
        page-break-after: avoid;
    }
    
    pre, table {
        page-break-inside: avoid;
    }
}

/* ===== RESPONSIVE DESIGN ===== */
@media (max-width: 768px) {
    body {
        padding: var(--spacing-md) var(--spacing-sm);
        font-size: 14px;
    }
    
    .container {
        padding: var(--spacing-lg);
    }
    
    h1 {
        font-size: 2rem;
    }
    
    h2 {
        font-size: 1.5rem;
    }
    
    h3 {
        font-size: 1.25rem;
    }
    
    table {
        font-size: 0.9em;
    }
    
    th, td {
        padding: var(--spacing-sm);
    }
}

/* ===== ADDITIONAL UTILITY CLASSES ===== */
.text-center {
    text-align: center;
}

.text-right {
    text-align: right;
}

.margin-top-lg {
    margin-top: var(--spacing-2xl);
}

.margin-bottom-lg {
    margin-bottom: var(--spacing-2xl);
}

.highlight {
    background: linear-gradient(120deg, #fef3c7 0%, #fde68a 100%);
    padding: 0 var(--spacing-xs);
    border-radius: 3px;
}

/* ===== SECTION DIVIDERS ===== */
.section-divider {
    display: flex;
    align-items: center;
    text-align: center;
    margin: var(--spacing-2xl) 0;
}

.section-divider::before,
.section-divider::after {
    content: '';
    flex: 1;
    border-bottom: 2px solid var(--border-medium);
}

.section-divider::before {
    margin-right: var(--spacing-md);
}

.section-divider::after {
    margin-left: var(--spacing-md);
}

/* ===== FOOTER ===== */
footer {
    margin-top: var(--spacing-2xl);
    padding-top: var(--spacing-lg);
    border-top: 2px solid var(--border-light);
    text-align: center;
    color: var(--text-secondary);
    font-size: 0.9em;
}

    </style>
</head>
<body>
    <div class="container">
<h1>GCAM Add Areas to Files Script Documentation</h1>
<h2>Overview</h2>
<p><strong>Script Name:</strong> <code>gcam_add_areas_to_files.py</code></p>
<p><strong>Purpose:</strong> Adds land allocation area data as an additional column to GCAM (Global Change Analysis Model) output files. This script matches area information from detailed land allocation files with other GCAM datasets (such as agricultural commodity prices, CO2 emissions, or vegetation/soil scalars) based on scenario, geographical unit, category, and year.</p>
<p><strong>Author:</strong> Philip Myint (myint1@llnl.gov) and Dalei Hao (dalei.hao@pnnl.gov)</p>
<p><strong>Repository:</strong> <a href="https://github.com/philipmyint/e3sm--gcam_analysis">E3SM-GCAM Analysis Scripts</a></p>
<hr />
<h2>Script Description</h2>
<p>The <code>gcam_add_areas_to_files.py</code> script enriches GCAM output files by adding land area information, enabling area-weighted calculations and analyses. The script matches entries between a target data file and a land allocation reference file based on common identifiers (scenario, region/basin, category, year).</p>
<h3>Key Features</h3>
<ul>
<li><strong>Parallel Processing:</strong> Utilizes multiprocessing to add areas to different data subsets simultaneously</li>
<li><strong>Flexible Matching:</strong> Supports matching at both regional and basin (watershed) levels</li>
<li><strong>JSON Configuration:</strong> All parameters specified through JSON files for easy customization</li>
<li><strong>Multiple File Processing:</strong> Can process multiple files in sequence from a single JSON configuration</li>
<li><strong>Crop Name Standardization:</strong> Optional conversion to standardized crop naming conventions</li>
<li><strong>Area Aggregation:</strong> Automatically sums areas across basins when matching at regional level</li>
</ul>
<h3>Workflow</h3>
<ol>
<li>Reads target data file and land allocation reference file</li>
<li>Extracts unique scenarios, geographical units, and categories</li>
<li>Creates Cartesian product of all combinations</li>
<li>For each combination:<br />
   - Matches entries in both files<br />
   - Extracts corresponding area values<br />
   - Handles missing matches (sets area to 0)</li>
<li>Concatenates all subsets into complete dataset</li>
<li>Optionally standardizes crop names</li>
<li>Outputs enhanced file with area column</li>
</ol>
<hr />
<h2>Function Documentation</h2>
<h3><code>add_areas_to_subset_of_file(df, df_land, geographical_label, category_label, scenario, geography, category)</code></h3>
<p><strong>Purpose:</strong> Core function that adds land allocation areas to a specific subset of data matching given criteria.</p>
<p><strong>Parameters:</strong><br />
- <code>df</code> (DataFrame): Target data containing the quantity of interest<br />
- <code>df_land</code> (DataFrame): Reference data containing land allocation areas<br />
- <code>geographical_label</code> (str): Column name for geographical unit ('region' or 'basin')<br />
- <code>category_label</code> (str): Column name for category ('sector' or 'landtype')<br />
- <code>scenario</code> (str): Scenario/simulation name to match<br />
- <code>geography</code> (str): Specific geographical unit name (e.g., 'USA', 'Amazon_Basin')<br />
- <code>category</code> (str): Specific category name (e.g., 'Corn', 'Forest')</p>
<p><strong>Returns:</strong> DataFrame with added 'area' column</p>
<p><strong>Process:</strong><br />
1. Filters both DataFrames to matching scenario, geography, and category<br />
2. Identifies year range from target data<br />
3. If no matching land allocation data found, sets areas to 0<br />
4. For regional matching: Sums areas across all basins for each year<br />
5. For basin matching: Aggregates areas across all regions containing that basin<br />
6. Returns enhanced DataFrame with area column</p>
<hr />
<h3><code>add_areas_to_file(inputs)</code></h3>
<p><strong>Purpose:</strong> Orchestrates the process of adding areas to an entire file based on JSON configuration.</p>
<p><strong>Parameters:</strong><br />
- <code>inputs</code> (dict): Dictionary containing all configuration parameters (see Input Parameters Table below)</p>
<p><strong>Returns:</strong> None (writes output to file)</p>
<p><strong>Process:</strong><br />
1. Unpacks input parameters from dictionary<br />
2. Reads target file and land allocation file into DataFrames<br />
3. Extracts unique values for scenarios, geographies, and categories<br />
4. Creates Cartesian product of all combinations<br />
5. Processes each combination in parallel using multiprocessing<br />
6. Concatenates results and sorts by key columns<br />
7. Optionally applies crop name standardization<br />
8. Writes enhanced data to output file<br />
9. Reports execution time</p>
<hr />
<h2>Input Parameters Table</h2>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Default Value</th>
<th>Possible Values</th>
<th>Required?</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>input_file</code></td>
<td>None</td>
<td>Valid file path to CSV or .dat file</td>
<td><strong>Yes</strong></td>
<td>Path to the input file that needs area data added</td>
</tr>
<tr>
<td><code>output_file</code></td>
<td>None</td>
<td>Valid file path to CSV or .dat file</td>
<td><strong>Yes</strong></td>
<td>Path where the enhanced file with areas will be saved</td>
</tr>
<tr>
<td><code>key_columns</code></td>
<td>None</td>
<td>List of valid column names</td>
<td><strong>Yes</strong></td>
<td>Columns used for sorting the final output (e.g., <code>["scenario", "region", "sector", "year"]</code>)</td>
</tr>
<tr>
<td><code>geographical_label</code></td>
<td>None</td>
<td><code>"region"</code> or <code>"basin"</code></td>
<td><strong>Yes</strong></td>
<td>Column name identifying geographical units in the data</td>
</tr>
<tr>
<td><code>category_label</code></td>
<td>None</td>
<td><code>"sector"</code>, <code>"landtype"</code>, or any valid column name</td>
<td><strong>Yes</strong></td>
<td>Column name identifying categories (e.g., crop types, sectors)</td>
</tr>
<tr>
<td><code>land_allocation_file</code></td>
<td>None</td>
<td>Valid file path to land allocation CSV or .dat file</td>
<td><strong>Yes</strong></td>
<td>Path to reference file containing land allocation area data</td>
</tr>
<tr>
<td><code>call_modify_crop_names</code></td>
<td><code>False</code></td>
<td><code>true</code> or <code>false</code></td>
<td>No</td>
<td>Whether to standardize crop names using GCAM mapping conventions</td>
</tr>
<tr>
<td><code>mean_or_sum_if_more_than_one_row_in_same_landtype_group</code></td>
<td><code>None</code></td>
<td><code>"area_weighted_mean"</code>, <code>"sum"</code>, or <code>None</code></td>
<td>No</td>
<td>How to aggregate when multiple rows map to same standardized landtype</td>
</tr>
</tbody>
</table>
<hr />
<h2>Detailed Parameter Descriptions</h2>
<h3>Required Parameters</h3>
<h4><code>input_file</code></h4>
<p><strong>Type:</strong> String (file path)</p>
<p><strong>Description:</strong> Path to the GCAM output file that requires area information.</p>
<p><strong>Examples:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nt">&quot;input_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="nt">&quot;./../2025_DiVittorio_et_al_gcam/ag_commodity_prices_processed.csv&quot;</span>
<span class="nt">&quot;input_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/path/to/your/data/emissions_by_sector.csv&quot;</span>
</code></pre></div>

<p><strong>Supported Formats:</strong> CSV (.csv) or fixed-width format (.dat) files</p>
<p><strong>Expected Structure:</strong> Must contain columns for scenario, geographical unit, category (if applicable), and year</p>
<hr />
<h4><code>output_file</code></h4>
<p><strong>Type:</strong> String (file path)</p>
<p><strong>Description:</strong> Path where the enhanced file with area column will be saved.</p>
<p><strong>Examples:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nt">&quot;output_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="nt">&quot;./../2025_DiVittorio_et_al_gcam/ag_commodity_prices_processed.csv&quot;</span>
<span class="nt">&quot;output_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/path/to/output/emissions_with_areas.csv&quot;</span>
</code></pre></div>

<p><strong>Note:</strong> Can be the same as <code>input_file</code> to overwrite the original file, or a different path to preserve the original.</p>
<p><strong>Output Format:</strong> Matches input format (CSV or .dat)</p>
<hr />
<h4><code>key_columns</code></h4>
<p><strong>Type:</strong> List of strings</p>
<p><strong>Description:</strong> Column names used for sorting the final output DataFrame. Order matters - data will be sorted by the first column, then second, etc.</p>
<p><strong>Examples:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nt">&quot;key_columns&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;scenario&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;region&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;sector&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;year&quot;</span><span class="p">]</span>
<span class="nt">&quot;key_columns&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;scenario&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;region&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;basin&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;landtype&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;year&quot;</span><span class="p">]</span>
</code></pre></div>

<p><strong>Common Patterns:</strong><br />
- Regional data: <code>["scenario", "region", "category", "year"]</code><br />
- Basin data: <code>["scenario", "region", "basin", "landtype", "year"]</code><br />
- Sector data: <code>["scenario", "region", "sector", "year"]</code></p>
<p><strong>Important:</strong> All columns listed must exist in the input file.</p>
<hr />
<h4><code>geographical_label</code></h4>
<p><strong>Type:</strong> String</p>
<p><strong>Description:</strong> Column name that identifies geographical units in the data.</p>
<p><strong>Possible Values:</strong><br />
- <code>"region"</code> - For GCAM regions (e.g., USA, China, Brazil)<br />
- <code>"basin"</code> - For watersheds/catchments (e.g., Amazon_Basin, Mississippi_Basin)</p>
<p><strong>Examples:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nt">&quot;geographical_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="nt">&quot;region&quot;</span>
<span class="nt">&quot;geographical_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;basin&quot;</span>
</code></pre></div>

<p><strong>Behavior:</strong><br />
- <strong>Region level:</strong> Areas are summed across all basins within each region<br />
- <strong>Basin level:</strong> Areas are collected from all regions that contain portions of that basin</p>
<hr />
<h4><code>category_label</code></h4>
<p><strong>Type:</strong> String</p>
<p><strong>Description:</strong> Column name that identifies the category of data (e.g., crop types, sectors, land uses).</p>
<p><strong>Possible Values:</strong> Any valid column name from the input file<br />
- <code>"sector"</code> - For economic sectors<br />
- <code>"landtype"</code> - For land use types or crop types<br />
- <code>"commodity"</code> - For agricultural commodities<br />
- Custom column names as needed</p>
<p><strong>Examples:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nt">&quot;category_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="nt">&quot;sector&quot;</span>
<span class="nt">&quot;category_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;landtype&quot;</span>
</code></pre></div>

<p><strong>Usage Context:</strong><br />
- Agricultural commodity prices: <code>"sector"</code><br />
- Land allocation data: <code>"landtype"</code><br />
- Emissions data: <code>"sector"</code><br />
- Vegetation/soil scalars: <code>"landtype"</code></p>
<hr />
<h4><code>land_allocation_file</code></h4>
<p><strong>Type:</strong> String (file path)</p>
<p><strong>Description:</strong> Path to the reference file containing detailed land allocation area data. This file must have been previously extracted and processed from GCAM outputs.</p>
<p><strong>Examples:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nt">&quot;land_allocation_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="nt">&quot;./../2025_DiVittorio_et_al_gcam/land_allocation_processed.csv&quot;</span>
<span class="nt">&quot;land_allocation_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./../2025_DiVittorio_et_al_gcam/land_allocation_processed_original_crop_names.csv&quot;</span>
</code></pre></div>

<p><strong>Required Structure:</strong><br />
- Must contain columns: <code>scenario</code>, <code>region</code>, <code>basin</code>, <code>landtype</code>, <code>year</code>, <code>value</code><br />
- The <code>value</code> column contains area measurements<br />
- Should cover all scenarios, regions, basins, and years present in input file</p>
<p><strong>Important Notes:</strong><br />
- Choose the correct land allocation file based on crop naming convention<br />
- For standardized crop names: use <code>land_allocation_processed.csv</code><br />
- For original GCAM crop names: use <code>land_allocation_processed_original_crop_names.csv</code></p>
<hr />
<h3>Optional Parameters</h3>
<h4><code>call_modify_crop_names</code></h4>
<p><strong>Type:</strong> Boolean</p>
<p><strong>Default:</strong> <code>false</code></p>
<p><strong>Description:</strong> Determines whether to apply crop name standardization after adding areas. When enabled, converts original GCAM crop names to standardized names defined in the <code>gcam_crop_mappings</code> dictionary.</p>
<p><strong>Possible Values:</strong><br />
- <code>true</code> - Apply crop name standardization<br />
- <code>false</code> - Keep original crop names</p>
<p><strong>Examples:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nt">&quot;call_modify_crop_names&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="nt">&quot;call_modify_crop_names&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
</code></pre></div>

<p><strong>When to Use:</strong><br />
- Set to <code>true</code> when working with vegetation/soil scalar files<br />
- Set to <code>true</code> when harmonizing crop names across different data sources<br />
- Set to <code>false</code> for regional/sectoral data that doesn't involve crop-specific categories</p>
<p><strong>Standardization Examples:</strong><br />
- <code>biomass</code>, <code>biomassGrass</code>, <code>biomassTree</code> → <code>BioenergyCrop</code><br />
- <code>Forest</code>, <code>ProtectedUnmanagedForest</code>, <code>UnmanagedForest</code> → <code>forest</code> (aggregate)<br />
- See <code>utility_gcam.py</code> for complete mapping definitions</p>
<hr />
<h4><code>mean_or_sum_if_more_than_one_row_in_same_landtype_group</code></h4>
<p><strong>Type:</strong> String or None</p>
<p><strong>Default:</strong> <code>None</code></p>
<p><strong>Description:</strong> Specifies how to aggregate data when crop name standardization causes multiple rows to map to the same standardized landtype.</p>
<p><strong>Possible Values:</strong><br />
- <code>"area_weighted_mean"</code> - Calculate weighted average using area as weight<br />
- <code>"sum"</code> - Sum all values<br />
- <code>None</code> - No aggregation (may result in duplicate rows)</p>
<p><strong>Examples:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nt">&quot;mean_or_sum_if_more_than_one_row_in_same_landtype_group&quot;</span><span class="p">:</span><span class="w"> </span><span class="nt">&quot;area_weighted_mean&quot;</span>
<span class="nt">&quot;mean_or_sum_if_more_than_one_row_in_same_landtype_group&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sum&quot;</span>
</code></pre></div>

<p><strong>When to Use:</strong><br />
- <code>"area_weighted_mean"</code> - For intensive properties (e.g., vegetation scalars, soil carbon density)<br />
- <code>"sum"</code> - For extensive properties (e.g., total emissions, total production)<br />
- <code>None</code> - When no standardization is applied or aggregation is not needed</p>
<p><strong>Usage Context:</strong><br />
- Required when <code>call_modify_crop_names</code> is <code>true</code><br />
- Particularly important for scalar files where values represent rates or densities</p>
<hr />
<h2>JSON Configuration File Structure</h2>
<h3>File Format</h3>
<p>The script accepts JSON configuration files containing an array of configuration objects. Each object represents one file to process.</p>
<p><strong>Basic Structure:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;input_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;path/to/input.csv&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;output_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;path/to/output.csv&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;key_columns&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;scenario&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;region&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;sector&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
<span class="w">        </span><span class="nt">&quot;geographical_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;region&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;category_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sector&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;land_allocation_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;path/to/land_allocation.csv&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Additional file configurations...</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">]</span>
</code></pre></div>

<h3>Example Configurations</h3>
<h4>Example 1: Regional Agricultural Commodity Prices</h4>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;input_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./../2025_DiVittorio_et_al_gcam/ag_commodity_prices_processed.csv&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;output_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./../2025_DiVittorio_et_al_gcam/ag_commodity_prices_processed.csv&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;key_columns&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;scenario&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;region&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;sector&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;geographical_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;region&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;category_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sector&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;land_allocation_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./../2025_DiVittorio_et_al_gcam/land_allocation_processed.csv&quot;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Use Case:</strong> Adding areas to agricultural commodity price data at the regional level.</p>
<p><strong>Key Features:</strong><br />
- Matches at regional level (areas summed across basins)<br />
- Uses "sector" as category label<br />
- No crop name standardization needed<br />
- Output overwrites input file</p>
<hr />
<h4>Example 2: Basin-Level Vegetation and Soil Scalars with Crop Standardization</h4>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;input_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./../2025_DiVittorio_et_al_gcam/scalars_control+full_feedback.csv&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;output_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./../2025_DiVittorio_et_al_gcam/scalars_control+full_feedback.csv&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;key_columns&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;scenario&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;region&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;basin&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;landtype&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;geographical_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;basin&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;category_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;landtype&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;land_allocation_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./../2025_DiVittorio_et_al_gcam/land_allocation_processed_original_crop_names.csv&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;call_modify_crop_names&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;mean_or_sum_if_more_than_one_row_in_same_landtype_group&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;area_weighted_mean&quot;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Use Case:</strong> Adding areas to vegetation/soil scalar files at the basin level with crop name harmonization.</p>
<p><strong>Key Features:</strong><br />
- Matches at basin level (more granular than regional)<br />
- Uses "landtype" as category label<br />
- Applies crop name standardization<br />
- Uses area-weighted mean for aggregation (appropriate for intensive properties like scalars)<br />
- Uses land allocation file with original crop names for proper matching</p>
<hr />
<h4>Example 3: Ensemble Data Processing</h4>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;input_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./../2025_DiVittorio_et_al_gcam/ag_commodity_prices_processed_ensemble.csv&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;output_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./../2025_DiVittorio_et_al_gcam/ag_commodity_prices_processed_ensemble.csv&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;key_columns&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;scenario&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;region&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;sector&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;geographical_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;region&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;category_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sector&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;land_allocation_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./../2025_DiVittorio_et_al_gcam/land_allocation_processed_ensemble.csv&quot;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Use Case:</strong> Processing ensemble simulation data with multiple scenario variations.</p>
<p><strong>Key Features:</strong><br />
- Works with ensemble files containing multiple scenario variations<br />
- Uses corresponding ensemble land allocation file<br />
- Same configuration structure as non-ensemble files</p>
<hr />
<h2>Usage Instructions</h2>
<h3>Command Line Execution</h3>
<p><strong>Basic Syntax:</strong></p>
<div class="codehilite"><pre><span></span><code>python<span class="w"> </span>gcam_add_areas_to_files.py<span class="w"> </span>path/to/config.json
</code></pre></div>

<p><strong>Multiple Configuration Files:</strong></p>
<div class="codehilite"><pre><span></span><code>python<span class="w"> </span>gcam_add_areas_to_files.py<span class="w"> </span>config1.json<span class="w"> </span>config2.json<span class="w"> </span>config3.json
</code></pre></div>

<p><strong>With Full Paths:</strong></p>
<div class="codehilite"><pre><span></span><code>python<span class="w"> </span>gcam_add_areas_to_files.py<span class="w"> </span>/full/path/to/gcam_add_areas_to_files.json
</code></pre></div>

<h3>Example Workflow</h3>
<h4>Step 1: Prepare Land Allocation File</h4>
<p>Ensure you have extracted and processed land allocation data using <code>gcam_extract_csv_from_project_files.R</code> and <code>gcam_process_extracted_data.py</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Extract data from GCAM project files</span>
Rscript<span class="w"> </span>gcam_extract_csv_from_project_files.R<span class="w"> </span>extraction_config.json

<span class="c1"># Process extracted data</span>
python<span class="w"> </span>gcam_process_extracted_data.py<span class="w"> </span>processing_config.json
</code></pre></div>

<h4>Step 2: Create JSON Configuration</h4>
<p>Create a JSON file specifying which files need areas added:</p>
<p><strong>my_config.json:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;input_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./data/emissions_by_region.csv&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;output_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./data/emissions_by_region_with_areas.csv&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;key_columns&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;scenario&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;region&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;sector&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
<span class="w">        </span><span class="nt">&quot;geographical_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;region&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;category_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sector&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;land_allocation_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./data/land_allocation_processed.csv&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">]</span>
</code></pre></div>

<h4>Step 3: Run the Script</h4>
<div class="codehilite"><pre><span></span><code>python<span class="w"> </span>gcam_add_areas_to_files.py<span class="w"> </span>my_config.json
</code></pre></div>

<h4>Step 4: Verify Output</h4>
<p>Check the output file to ensure the 'area' column has been added:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./data/emissions_by_region_with_areas.csv&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>  <span class="c1"># Should include &#39;area&#39; column</span>
</code></pre></div>

<hr />
<h2>Understanding Area Matching Logic</h2>
<h3>Regional Matching (geographical_label: "region")</h3>
<p><strong>Process:</strong><br />
1. Filter land allocation data to matching scenario, region, and landtype<br />
2. For each year, sum areas across all basins within that region<br />
3. Assign summed area to corresponding entry in target data</p>
<p><strong>Example:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nx">Target</span><span class="w"> </span><span class="nx">Data</span><span class="p">:</span>
<span class="nx">scenario</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">region</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">sector</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">year</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">value</span>
<span class="o">---------|--------|--------|------|-------</span>
<span class="kd">base</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nx">USA</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nx">Corn</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="m m-Double">150.5</span>

<span class="nx">Land</span><span class="w"> </span><span class="nx">Allocation</span><span class="w"> </span><span class="nx">Data</span><span class="p">:</span>
<span class="nx">scenario</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">region</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nx">basin</span><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="nx">landtype</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">year</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="p">(</span><span class="nx">area</span><span class="p">)</span>
<span class="o">---------|-------------|-----------------|----------|------|-------------</span>
<span class="kd">base</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nx">USA</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="nx">Mississippi</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nx">Corn</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="m m-Double">45.2</span>
<span class="kd">base</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nx">USA</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="nx">Colorado</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nx">Corn</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="m m-Double">32.1</span>
<span class="kd">base</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nx">USA</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="nx">Columbia</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nx">Corn</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="m m-Double">28.8</span>

<span class="nx">Result</span><span class="p">:</span>
<span class="nx">scenario</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">region</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">sector</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">year</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">area</span>
<span class="o">---------|--------|--------|------|-------|-------</span>
<span class="kd">base</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nx">USA</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nx">Corn</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="m m-Double">150.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="m m-Double">106.1</span><span class="w">  </span><span class="p">(</span><span class="nx">sum</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">all</span><span class="w"> </span><span class="nx">basins</span><span class="p">)</span>
</code></pre></div>

<hr />
<h3>Basin Matching (geographical_label: "basin")</h3>
<p><strong>Process:</strong><br />
1. Filter land allocation data to matching scenario, basin, and landtype<br />
2. Some basins span multiple regions - collect areas from all relevant regions<br />
3. Assign area to corresponding entry for each region-basin combination</p>
<p><strong>Example:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nx">Target</span><span class="w"> </span><span class="nx">Data</span><span class="p">:</span>
<span class="nx">scenario</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">region</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nx">basin</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">landtype</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">year</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">value</span>
<span class="o">---------|-----------|-------------|----------|------|-------</span>
<span class="kd">base</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nx">USA</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">Colorado</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nx">Forest</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="m m-Double">82.3</span>
<span class="kd">base</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nx">Mexico</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nx">Colorado</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nx">Forest</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="m m-Double">18.5</span>

<span class="nx">Land</span><span class="w"> </span><span class="nx">Allocation</span><span class="w"> </span><span class="nx">Data</span><span class="p">:</span>
<span class="nx">scenario</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">region</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nx">basin</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">landtype</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">year</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="p">(</span><span class="nx">area</span><span class="p">)</span>
<span class="o">---------|-----------|-------------|----------|------|-------------</span>
<span class="kd">base</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nx">USA</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">Colorado</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nx">Forest</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="m m-Double">125.4</span>
<span class="kd">base</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nx">Mexico</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nx">Colorado</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nx">Forest</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="m m-Double">34.2</span>

<span class="nx">Result</span><span class="p">:</span>
<span class="nx">scenario</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">region</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nx">basin</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">landtype</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">year</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">area</span>
<span class="o">---------|-----------|-------------|----------|------|-------|-------</span>
<span class="kd">base</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nx">USA</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">Colorado</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nx">Forest</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="m m-Double">82.3</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="m m-Double">125.4</span>
<span class="kd">base</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nx">Mexico</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nx">Colorado</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nx">Forest</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="m m-Double">18.5</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="m m-Double">34.2</span>
</code></pre></div>

<hr />
<h3>Handling Missing Matches</h3>
<p>When no corresponding land allocation data is found for a particular combination:<br />
- Area is set to <strong>0</strong><br />
- No error is raised<br />
- Processing continues normally</p>
<p><strong>Common Reasons for Missing Matches:</strong><br />
- Category exists in target data but not in land allocation<br />
- Geographical unit has no land allocation for that category<br />
- Year range mismatch between files<br />
- Scenario name mismatch</p>
<hr />
<h2>Crop Name Standardization</h2>
<h3>Overview</h3>
<p>When <code>call_modify_crop_names</code> is set to <code>true</code>, the script applies standardization mappings defined in the <code>gcam_crop_mappings</code> dictionary from <code>utility_gcam.py</code>.</p>
<h3>Standard Mappings</h3>
<p><strong>Bioenergy Crops:</strong></p>
<div class="codehilite"><pre><span></span><code>biomass, biomassGrass, biomassTree → BioenergyCrop
</code></pre></div>

<p><strong>Forest Aggregation:</strong></p>
<div class="codehilite"><pre><span></span><code>Forest, ProtectedUnmanagedForest, UnmanagedForest → forest
</code></pre></div>

<p><strong>Grassland Aggregation:</strong></p>
<div class="codehilite"><pre><span></span><code>Grassland, ProtectedUnmanagedGrassland, UnmanagedGrassland → grassland
</code></pre></div>

<p><strong>Shrubland Aggregation:</strong></p>
<div class="codehilite"><pre><span></span><code>Shrubland, ProtectedUnmanagedShrubland, UnmanagedShrubland → shrubland
</code></pre></div>

<p><strong>Other Examples:</strong></p>
<div class="codehilite"><pre><span></span><code>Corn → Corn (unchanged)
FodderGrass → FodderGrass (unchanged)
Rice → Rice (unchanged)
</code></pre></div>

<h3>Aggregation After Standardization</h3>
<p>When multiple original crop types map to the same standardized name, aggregation is controlled by <code>mean_or_sum_if_more_than_one_row_in_same_landtype_group</code>:</p>
<p><strong>Area-Weighted Mean (for intensive properties):</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Example: Vegetation scalars</span>
<span class="n">biomass</span><span class="p">:</span>      <span class="n">area</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">vegetation</span><span class="o">=</span><span class="mf">1.2</span>
<span class="n">biomassGrass</span><span class="p">:</span> <span class="n">area</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">vegetation</span><span class="o">=</span><span class="mf">1.5</span>
<span class="n">biomassTree</span><span class="p">:</span>  <span class="n">area</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">vegetation</span><span class="o">=</span><span class="mf">1.1</span>

<span class="c1"># After standardization to BioenergyCrop:</span>
<span class="n">BioenergyCrop</span><span class="p">:</span> <span class="n">area</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">vegetation</span><span class="o">=</span><span class="p">(</span><span class="mi">50</span><span class="o">*</span><span class="mf">1.2</span> <span class="o">+</span> <span class="mi">30</span><span class="o">*</span><span class="mf">1.5</span> <span class="o">+</span> <span class="mi">20</span><span class="o">*</span><span class="mf">1.1</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span> <span class="o">=</span> <span class="mf">1.27</span>
</code></pre></div>

<p><strong>Sum (for extensive properties):</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Example: Total emissions</span>
<span class="n">biomass</span><span class="p">:</span>      <span class="n">area</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">emissions</span><span class="o">=</span><span class="mi">120</span>
<span class="n">biomassGrass</span><span class="p">:</span> <span class="n">area</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">emissions</span><span class="o">=</span><span class="mi">85</span>
<span class="n">biomassTree</span><span class="p">:</span>  <span class="n">area</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">emissions</span><span class="o">=</span><span class="mi">45</span>

<span class="c1"># After standardization to BioenergyCrop:</span>
<span class="n">BioenergyCrop</span><span class="p">:</span> <span class="n">area</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">emissions</span><span class="o">=</span><span class="mi">250</span> <span class="p">(</span><span class="mi">120</span><span class="o">+</span><span class="mi">85</span><span class="o">+</span><span class="mi">45</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2>Performance Considerations</h2>
<h3>Multiprocessing</h3>
<p>The script uses all available CPU cores for parallel processing:</p>
<div class="codehilite"><pre><span></span><code><span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
    <span class="n">dataframes_for_each_subset</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">add_areas_to_subset_of_file</span><span class="p">,</span> <span class="n">cartesian_product</span><span class="p">))</span>
</code></pre></div>

<p><strong>Performance Factors:</strong><br />
- Number of scenarios<br />
- Number of geographical units (regions/basins)<br />
- Number of categories (sectors/landtypes)<br />
- Number of years<br />
- CPU core count</p>
<p><strong>Scalability:</strong><br />
- Processing time scales roughly linearly with Cartesian product size<br />
- More CPU cores = faster processing for large datasets</p>
<h3>Execution Time</h3>
<p><strong>Typical Performance:</strong><br />
- Small files (&lt; 10,000 rows): 1-5 seconds<br />
- Medium files (10,000-100,000 rows): 5-30 seconds<br />
- Large files (&gt; 100,000 rows): 30-120 seconds<br />
- Ensemble files: Multiply by number of scenarios</p>
<p><strong>Timing Output:</strong></p>
<div class="codehilite"><pre><span></span><code>Elapsed time for adding areas to ag_commodity_prices_processed.csv: 12.34 seconds
Elapsed time for adding areas to scalars_control+full_feedback.csv: 45.67 seconds
Elapsed time for adding areas to all files: 58.01 seconds
</code></pre></div>

<h3>Memory Requirements</h3>
<p><strong>Memory Usage Estimation:</strong></p>
<div class="codehilite"><pre><span></span><code>Peak Memory ≈ (Input File Size + Land Allocation File Size) × Number of CPU Cores × 1.5
</code></pre></div>

<p><strong>Example:</strong><br />
- Input file: 50 MB<br />
- Land allocation file: 200 MB<br />
- CPU cores: 8<br />
- Estimated peak memory: (50 + 200) × 8 × 1.5 = 3 GB</p>
<p><strong>Optimization Tips:</strong><br />
- Process files with fewer scenarios/categories first<br />
- Close unnecessary applications to free memory<br />
- For very large ensembles, process subset of files at a time</p>
<hr />
<h2>Dependencies</h2>
<h3>Required Python Modules</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>        <span class="c1"># Standard library</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>            <span class="c1"># Standard library</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span> <span class="c1"># Standard library</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>    <span class="c1"># Install: pip install pandas</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>            <span class="c1"># Standard library</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>           <span class="c1"># Standard library</span>
</code></pre></div>

<h3>Custom Utility Modules</h3>
<p><strong>From <code>utility_constants.py</code>:</strong><br />
- Various constants used throughout the analysis pipeline</p>
<p><strong>From <code>utility_dataframes.py</code>:</strong><br />
- <code>read_file_into_dataframe(file)</code> - Reads CSV or .dat files<br />
- <code>write_dataframe_to_file(df, file)</code> - Writes to CSV or .dat files</p>
<p><strong>From <code>utility_gcam.py</code>:</strong><br />
- <code>modify_crop_names(df, key_columns, aggregation_method)</code> - Standardizes crop names</p>
<p><strong>Installation:</strong><br />
Ensure all utility modules are available in the Python path or the same directory as the script.</p>
<hr />
<h2>Output File Structure</h2>
<h3>Added Column</h3>
<p>The script adds a single new column to the input file:</p>
<p><strong>Column Name:</strong> <code>area</code></p>
<p><strong>Data Type:</strong> Float</p>
<p><strong>Units:</strong> Typically thousands of square kilometers (km²), depending on GCAM output units</p>
<p><strong>Position:</strong> Appended as the last column (rightmost)</p>
<h3>Example Output Structure</h3>
<p><strong>Before (Input):</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">scenario</span><span class="p">,</span><span class="n">region</span><span class="p">,</span><span class="n">sector</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">value</span>
<span class="n">base</span><span class="p">,</span><span class="n">USA</span><span class="p">,</span><span class="n">Corn</span><span class="p">,</span><span class="mh">2020</span><span class="p">,</span><span class="mf">150.5</span>
<span class="n">base</span><span class="p">,</span><span class="n">USA</span><span class="p">,</span><span class="n">Corn</span><span class="p">,</span><span class="mh">2025</span><span class="p">,</span><span class="mf">158.2</span>
<span class="n">base</span><span class="p">,</span><span class="n">USA</span><span class="p">,</span><span class="n">Wheat</span><span class="p">,</span><span class="mh">2020</span><span class="p">,</span><span class="mf">95.3</span>
</code></pre></div>

<p><strong>After (Output):</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">scenario</span><span class="p">,</span><span class="n">region</span><span class="p">,</span><span class="n">sector</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">area</span>
<span class="n">base</span><span class="p">,</span><span class="n">USA</span><span class="p">,</span><span class="n">Corn</span><span class="p">,</span><span class="mh">2020</span><span class="p">,</span><span class="mf">150.5</span><span class="p">,</span><span class="mf">106.1</span>
<span class="n">base</span><span class="p">,</span><span class="n">USA</span><span class="p">,</span><span class="n">Corn</span><span class="p">,</span><span class="mh">2025</span><span class="p">,</span><span class="mf">158.2</span><span class="p">,</span><span class="mf">108.7</span>
<span class="n">base</span><span class="p">,</span><span class="n">USA</span><span class="p">,</span><span class="n">Wheat</span><span class="p">,</span><span class="mh">2020</span><span class="p">,</span><span class="mf">95.3</span><span class="p">,</span><span class="mf">82.4</span>
</code></pre></div>

<h3>Data Sorting</h3>
<p>Output is sorted according to <code>key_columns</code> specification:<br />
- Primary sort: First column in key_columns<br />
- Secondary sort: Second column in key_columns<br />
- And so on...</p>
<hr />
<h2>Common Use Cases</h2>
<h3>Use Case 1: Area-Weighted Regional Analysis</h3>
<p><strong>Goal:</strong> Calculate area-weighted average agricultural commodity prices by region</p>
<p><strong>Configuration:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;input_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./data/ag_prices.csv&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;output_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./data/ag_prices_with_areas.csv&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;key_columns&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;scenario&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;region&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;sector&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;geographical_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;region&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;category_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sector&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;land_allocation_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./data/land_allocation.csv&quot;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Post-Processing:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./data/ag_prices_with_areas.csv&#39;</span><span class="p">)</span>

<span class="c1"># Calculate area-weighted average price</span>
<span class="n">weighted_avg</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</code></pre></div>

<hr />
<h3>Use Case 2: Basin-Level Ecosystem Analysis</h3>
<p><strong>Goal:</strong> Analyze vegetation scalars at the basin level with standardized crop names</p>
<p><strong>Configuration:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;input_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./data/veg_scalars.csv&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;output_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./data/veg_scalars_with_areas.csv&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;key_columns&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;scenario&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;region&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;basin&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;landtype&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;geographical_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;basin&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;category_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;landtype&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;land_allocation_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./data/land_allocation_original_names.csv&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;call_modify_crop_names&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;mean_or_sum_if_more_than_one_row_in_same_landtype_group&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;area_weighted_mean&quot;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Benefits:</strong><br />
- Harmonized crop names across datasets<br />
- Area-weighted aggregation for physically meaningful averages<br />
- Basin-level spatial resolution for watershed analysis</p>
<hr />
<h3>Use Case 3: Ensemble Time Series Comparison</h3>
<p><strong>Goal:</strong> Compare land use changes across ensemble members with area weighting</p>
<p><strong>Configuration:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;input_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./data/land_use_ensemble.csv&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;output_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./data/land_use_ensemble_with_areas.csv&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;key_columns&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;scenario&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;region&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;landtype&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;geographical_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;region&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;category_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;landtype&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;land_allocation_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./data/land_allocation_ensemble.csv&quot;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Analysis:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./data/land_use_ensemble_with_areas.csv&#39;</span><span class="p">)</span>

<span class="c1"># Group by scenario and year, calculate area-weighted mean</span>
<span class="n">grouped</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;scenario&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="p">)</span>

<span class="c1"># Plot ensemble spread</span>
<span class="n">grouped</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Area-weighted mean land use change&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2>Troubleshooting</h2>
<h3>Common Issues and Solutions</h3>
<h4>Issue 1: FileNotFoundError</h4>
<p><strong>Error Message:</strong></p>
<div class="codehilite"><pre><span></span><code>FileNotFoundError: [Errno 2] No such file or directory: &#39;./data/input.csv&#39;
</code></pre></div>

<p><strong>Causes:</strong><br />
- Incorrect file path in JSON configuration<br />
- File hasn't been created yet<br />
- Working directory is different than expected</p>
<p><strong>Solutions:</strong><br />
- Verify file paths are correct (use absolute paths if uncertain)<br />
- Check that input files exist before running<br />
- Use <code>pwd</code> command to check current working directory</p>
<hr />
<h4>Issue 2: KeyError on Column Names</h4>
<p><strong>Error Message:</strong></p>
<div class="codehilite"><pre><span></span><code>KeyError: &#39;sector&#39;
</code></pre></div>

<p><strong>Causes:</strong><br />
- Column specified in JSON doesn't exist in input file<br />
- Typo in column name (case-sensitive)<br />
- File structure different than expected</p>
<p><strong>Solutions:</strong><br />
- Verify column names using: <code>df.columns.tolist()</code><br />
- Check for exact spelling and capitalization<br />
- Inspect a few rows of the input file: <code>df.head()</code></p>
<hr />
<h4>Issue 3: No Areas Added (All Zeros)</h4>
<p><strong>Symptom:</strong> Area column added but all values are 0</p>
<p><strong>Causes:</strong><br />
- Mismatch between category names in input and land allocation files<br />
- Scenario names don't match<br />
- Geographical units don't match<br />
- Year ranges don't overlap</p>
<p><strong>Solutions:</strong><br />
- Check unique values: <code>df['category_label'].unique()</code><br />
- Verify scenario names match exactly<br />
- Ensure land allocation file covers the same time period<br />
- If using crop name standardization, ensure land allocation file uses corresponding naming convention</p>
<hr />
<h4>Issue 4: Memory Error</h4>
<p><strong>Error Message:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">MemoryError</span><span class="o">:</span><span class="w"> </span><span class="n">Unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">allocate</span><span class="w"> </span><span class="n">array</span>
</code></pre></div>

<p><strong>Causes:</strong><br />
- Files too large for available RAM<br />
- Too many simultaneous parallel processes<br />
- Cartesian product creates enormous intermediate dataset</p>
<p><strong>Solutions:</strong><br />
- Process fewer files at once<br />
- Reduce number of CPU cores (won't help much, but worth trying)<br />
- Split large files into smaller subsets<br />
- Close other applications to free memory<br />
- Use machine with more RAM</p>
<hr />
<h4>Issue 5: Slow Performance</h4>
<p><strong>Symptom:</strong> Script takes much longer than expected</p>
<p><strong>Causes:</strong><br />
- Very large Cartesian product (many scenarios × regions × categories)<br />
- Large land allocation file requiring repeated reads<br />
- Insufficient CPU cores</p>
<p><strong>Solutions:</strong><br />
- Check size of Cartesian product: scenarios × geographies × categories<br />
- Consider processing subsets of data separately<br />
- Ensure multiprocessing is working (should use multiple cores)<br />
- Verify no other intensive processes running</p>
<hr />
<h4>Issue 6: Incorrect Aggregation After Crop Standardization</h4>
<p><strong>Symptom:</strong> Values don't make sense after aggregation</p>
<p><strong>Causes:</strong><br />
- Using "sum" for intensive properties (should use area-weighted mean)<br />
- Using area-weighted mean for extensive properties (should use sum)</p>
<p><strong>Solutions:</strong><br />
- Use <code>"area_weighted_mean"</code> for: scalars, densities, rates, concentrations<br />
- Use <code>"sum"</code> for: totals, absolute quantities, production volumes<br />
- Verify units of the quantity being aggregated</p>
<hr />
<h2>Validation and Quality Checks</h2>
<h3>Recommended Checks After Running</h3>
<h4>1. Verify Area Column Added</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;output_file.csv&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="s1">&#39;area&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s2">&quot;Area column not added!&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✓ Area column successfully added&quot;</span><span class="p">)</span>
</code></pre></div>

<h4>2. Check for Missing Areas</h4>
<div class="codehilite"><pre><span></span><code><span class="n">zero_areas</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">zero_areas</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠ Warning: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">zero_areas</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows have zero area&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">zero_areas</span><span class="p">[[</span><span class="s1">&#39;scenario&#39;</span><span class="p">,</span> <span class="s1">&#39;region&#39;</span><span class="p">,</span> <span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✓ No zero areas found&quot;</span><span class="p">)</span>
</code></pre></div>

<h4>3. Verify Area Distributions</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">df</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;area&#39;</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Area Distribution by Category&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Area (1000 km²)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>

<h4>4. Check Total Areas by Scenario</h4>
<div class="codehilite"><pre><span></span><code><span class="n">total_areas</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;scenario&#39;</span><span class="p">)[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total areas by scenario:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">total_areas</span><span class="p">)</span>
</code></pre></div>

<h4>5. Validate Sorting</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Verify data is sorted according to key_columns</span>
<span class="n">key_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;scenario&#39;</span><span class="p">,</span> <span class="s1">&#39;region&#39;</span><span class="p">,</span> <span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">]</span>
<span class="n">is_sorted</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">key_cols</span><span class="p">]</span> <span class="o">==</span> <span class="n">df</span><span class="p">[</span><span class="n">key_cols</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">key_cols</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✓ Data properly sorted: </span><span class="si">{</span><span class="n">is_sorted</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2>Best Practices</h2>
<h3>1. File Organization</h3>
<ul>
<li>Keep land allocation files in a central reference directory</li>
<li>Use descriptive output file names</li>
<li>Maintain separate directories for processed vs. raw data</li>
<li>Document which land allocation file corresponds to which datasets</li>
</ul>
<h3>2. Configuration Management</h3>
<ul>
<li>Create separate JSON files for different analysis workflows</li>
<li>Comment JSON files (use external documentation file)</li>
<li>Version control JSON configurations</li>
<li>Use meaningful file and parameter names</li>
</ul>
<h3>3. Data Quality</h3>
<ul>
<li>Always validate land allocation files before use</li>
<li>Check for completeness (all scenarios, regions, years covered)</li>
<li>Verify units are consistent across files</li>
<li>Inspect sample outputs before processing entire ensemble</li>
</ul>
<h3>4. Processing Strategy</h3>
<ul>
<li>Process smaller test files first</li>
<li>Start with single files before batch processing</li>
<li>Monitor memory usage for large datasets</li>
<li>Keep backups of original files when overwriting</li>
</ul>
<h3>5. Documentation</h3>
<ul>
<li>Document which land allocation file was used for each analysis</li>
<li>Record any crop name standardization applied</li>
<li>Note aggregation methods used</li>
<li>Keep log of execution times for performance tracking</li>
</ul>
<hr />
<h2>Integration with Other Scripts</h2>
<h3>Typical Workflow Position</h3>
<div class="codehilite"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">gcam_extract_csv_from_project_files</span><span class="mf">.</span><span class="n">R</span>
<span class="w">   </span><span class="err">↓</span><span class="w"> </span><span class="p">(</span><span class="n">Extract</span><span class="w"> </span><span class="n">raw</span><span class="w"> </span><span class="kd">data</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">GCAM</span><span class="w"> </span><span class="n">project</span><span class="w"> </span><span class="n">files</span><span class="p">)</span>

<span class="mf">2.</span><span class="w"> </span><span class="n">gcam_process_extracted_data</span><span class="mf">.</span><span class="n">py</span>
<span class="w">   </span><span class="err">↓</span><span class="w"> </span><span class="p">(</span><span class="n">Clean</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="ow">or</span><span class="n">ganize</span><span class="w"> </span><span class="n">extracted</span><span class="w"> </span><span class="kd">data</span><span class="p">)</span>

<span class="mf">3.</span><span class="w"> </span><span class="n">gcam_add_areas_to_files</span><span class="mf">.</span><span class="n">py</span><span class="w">  </span><span class="err">←</span><span class="w"> </span><span class="n">THIS</span><span class="w"> </span><span class="n">SCRIPT</span>
<span class="w">   </span><span class="err">↓</span><span class="w"> </span><span class="p">(</span><span class="n">Enrich</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">land</span><span class="w"> </span><span class="n">allocation</span><span class="w"> </span><span class="n">areas</span><span class="p">)</span>

<span class="mf">4.</span><span class="w"> </span><span class="n">gcam_plot_time_series</span><span class="mf">.</span><span class="n">py</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">gcam_plot_spatial_data</span><span class="mf">.</span><span class="n">py</span>
<span class="w">   </span><span class="err">↓</span><span class="w"> </span><span class="p">(</span><span class="n">Visualize</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">analyze</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">area</span><span class="w"> </span><span class="n">weighting</span><span class="p">)</span>
</code></pre></div>

<h3>Upstream Dependencies</h3>
<p><strong>Required predecessor scripts:</strong><br />
- <code>gcam_extract_csv_from_project_files.R</code> - Must run first to extract land allocation data<br />
- <code>gcam_process_extracted_data.py</code> - Should run to clean and organize data</p>
<h3>Downstream Usage</h3>
<p><strong>Scripts that benefit from added area data:</strong><br />
- <code>gcam_plot_time_series.py</code> - Can create area-weighted plots<br />
- <code>gcam_plot_box_and_whiskers.py</code> - Can display area-weighted distributions<br />
- <code>gcam_plot_spatial_data.py</code> - Can show area-normalized spatial patterns</p>
<hr />
<h2>Related Scripts</h2>
<h3>Complementary GCAM Scripts</h3>
<p><strong><code>gcam_extract_csv_from_project_files.R</code></strong><br />
- Extracts data from GCAM project files (including land allocations)<br />
- Creates the land allocation reference files used by this script</p>
<p><strong><code>gcam_process_extracted_data.py</code></strong><br />
- Cleans and organizes extracted CSV files<br />
- Prepares files for area addition</p>
<p><strong><code>gcam_compile_ehc_scalars.py</code></strong><br />
- Compiles vegetation and soil scalar files<br />
- Output files often need areas added for weighted analysis</p>
<p><strong><code>gcam_plot_time_series.py</code></strong><br />
- Plots GCAM time series with optional area weighting<br />
- Directly uses output from this script</p>
<h3>Related E3SM Scripts</h3>
<p><strong><code>e3sm_extract_time_series_surfdata_iesm_dyn.py</code></strong><br />
- Extracts land surface data from E3SM<br />
- Creates analogous area data for E3SM analysis</p>
<hr />
<h2>Example JSON Configuration File</h2>
<p>Here is the complete example configuration file from the repository:</p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;input_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./../2025_DiVittorio_et_al_gcam/ag_commodity_prices_processed.csv&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;output_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./../2025_DiVittorio_et_al_gcam/ag_commodity_prices_processed.csv&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;key_columns&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;scenario&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;region&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;sector&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
<span class="w">        </span><span class="nt">&quot;geographical_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;region&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;category_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sector&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;land_allocation_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./../2025_DiVittorio_et_al_gcam/land_allocation_processed.csv&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;input_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./../2025_DiVittorio_et_al_gcam/ag_commodity_prices_processed_ensemble.csv&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;output_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./../2025_DiVittorio_et_al_gcam/ag_commodity_prices_processed_ensemble.csv&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;key_columns&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;scenario&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;region&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;sector&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
<span class="w">        </span><span class="nt">&quot;geographical_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;region&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;category_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sector&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;land_allocation_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./../2025_DiVittorio_et_al_gcam/land_allocation_processed_ensemble.csv&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;input_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./../2025_DiVittorio_et_al_gcam/scalars_control+full_feedback.csv&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;output_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./../2025_DiVittorio_et_al_gcam/scalars_control+full_feedback.csv&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;key_columns&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;scenario&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;region&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;basin&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;landtype&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
<span class="w">        </span><span class="nt">&quot;geographical_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;basin&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;category_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;landtype&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;land_allocation_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./../2025_DiVittorio_et_al_gcam/land_allocation_processed_original_crop_names.csv&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;call_modify_crop_names&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;mean_or_sum_if_more_than_one_row_in_same_landtype_group&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;area_weighted_mean&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;input_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./../2025_DiVittorio_et_al_gcam/scalars_control+full_feedback_ensemble.csv&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;output_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./../2025_DiVittorio_et_al_gcam/scalars_control+full_feedback_ensemble.csv&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;key_columns&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;scenario&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;region&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;basin&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;landtype&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
<span class="w">        </span><span class="nt">&quot;geographical_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;basin&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;category_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;landtype&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;land_allocation_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;./../2025_DiVittorio_et_al_gcam/land_allocation_processed_original_crop_names_ensemble.csv&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;call_modify_crop_names&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;mean_or_sum_if_more_than_one_row_in_same_landtype_group&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;area_weighted_mean&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">]</span>
</code></pre></div>

<p>This configuration processes four files:<br />
1. Base agricultural commodity prices<br />
2. Ensemble agricultural commodity prices<br />
3. Base vegetation/soil scalars with crop standardization<br />
4. Ensemble vegetation/soil scalars with crop standardization</p>
<hr />
<h2>References</h2>
<ul>
<li>DiVittorio et al. (2025). "E3SM-GCAM coupling methodology and applications." <em>Journal of Advances in Modeling Earth Systems</em>. <a href="https://agupubs.onlinelibrary.wiley.com/doi/full/10.1029/2024MS004806">DOI: 10.1029/2024MS004806</a></li>
<li>GitHub Repository: <a href="https://github.com/philipmyint/e3sm--gcam_analysis">https://github.com/philipmyint/e3sm--gcam_analysis</a></li>
<li>GCAM Documentation: <a href="https://gcims.pnnl.gov/modeling/gcam-global-change-analysis-model">https://gcims.pnnl.gov/modeling/gcam-global-change-analysis-model</a></li>
</ul>
<hr />
<h2>Contact</h2>
<p>For questions or issues:<br />
- <strong>Philip Myint</strong>: myint1@llnl.gov<br />
- <strong>Dalei Hao</strong>: dalei.hao@pnnl.gov</p>
<p>For bug reports or feature requests, please create an issue on the <a href="https://github.com/philipmyint/e3sm--gcam_analysis/issues">GitHub repository</a>.</p>
<hr />
<h2>Version History</h2>
<ul>
<li><strong>Current Version:</strong> As documented in repository (January 2025)</li>
<li><strong>Last Updated:</strong> January 2026</li>
</ul>
<hr />
<h2>Appendix: Quick Reference</h2>
<h3>Quick Start Checklist</h3>
<ul>
<li>[ ] Install required Python packages (pandas)</li>
<li>[ ] Ensure utility modules are accessible</li>
<li>[ ] Prepare land allocation reference file</li>
<li>[ ] Create JSON configuration file</li>
<li>[ ] Verify all file paths are correct</li>
<li>[ ] Run script with JSON file</li>
<li>[ ] Validate output has 'area' column</li>
<li>[ ] Check for zero or missing areas</li>
<li>[ ] Proceed with downstream analysis</li>
</ul>
<h3>Command Quick Reference</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Basic execution</span>
python<span class="w"> </span>gcam_add_areas_to_files.py<span class="w"> </span>config.json

<span class="c1"># Multiple configs</span>
python<span class="w"> </span>gcam_add_areas_to_files.py<span class="w"> </span>config1.json<span class="w"> </span>config2.json

<span class="c1"># View help (add to script if desired)</span>
python<span class="w"> </span>gcam_add_areas_to_files.py<span class="w"> </span>--help
</code></pre></div>

<h3>JSON Template</h3>
<div class="codehilite"><pre><span></span><code><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;input_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;path/to/input.csv&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;output_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;path/to/output.csv&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;key_columns&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;scenario&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;region&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;category&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
<span class="w">        </span><span class="nt">&quot;geographical_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;region or basin&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;category_label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sector or landtype&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;land_allocation_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;path/to/land_allocation.csv&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;call_modify_crop_names&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;mean_or_sum_if_more_than_one_row_in_same_landtype_group&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">]</span>
</code></pre></div>

<hr />
<p><em>This documentation provides comprehensive guidance for using the <code>gcam_add_areas_to_files.py</code> script to enrich GCAM output files with land allocation area data for area-weighted analyses.</em></p>
        
        <footer>
            <p>
                Documentation generated for the E3SM-GCAM Analysis Scripts<br>
                <strong>Authors:</strong> Philip Myint (myint1@llnl.gov) and Dalei Hao (dalei.hao@pnnl.gov)<br>
                <strong>Last Updated:</strong> January 2026
            </p>
        </footer>
    </div>
</body>
</html>
