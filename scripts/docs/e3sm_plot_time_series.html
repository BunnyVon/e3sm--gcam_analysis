<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E3SM Time Series Plotting Script Documentation</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1, h2, h3, h4 { color: #2c3e50; }
        h1 { border-bottom: 3px solid #3498db; padding-bottom: 10px; }
        h2 { border-bottom: 2px solid #bdc3c7; padding-bottom: 8px; margin-top: 40px; }
        h3 { color: #34495e; margin-top: 30px; }
        code {
            background-color: #ecf0f1;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
        }
        pre {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 0.9em;
        }
        pre code { background-color: transparent; padding: 0; color: inherit; }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #3498db; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #f1f1f1; }
        .note {
            background-color: #e8f4f8;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 5px 5px 0;
        }
        .warning {
            background-color: #fdf2e9;
            border-left: 4px solid #e67e22;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 5px 5px 0;
        }
        .example {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .example h4 { margin-top: 0; color: #27ae60; }
        .toc {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .toc ul { list-style-type: none; padding-left: 20px; }
        .toc > ul { padding-left: 0; }
        .toc a { color: #3498db; text-decoration: none; }
        .toc a:hover { text-decoration: underline; }
        .feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .feature-item {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .feature-item strong { color: #3498db; }
        hr { border: none; border-top: 1px solid #ddd; margin: 40px 0; }
    </style>
</head>
<body>

<h1>E3SM Time Series Plotting Script Documentation</h1>

<h2>Overview</h2>
<p><code>e3sm_plot_time_series.py</code> is a Python script for creating publication-quality time series plots from E3SM (Energy Exascale Earth System Model) output data. The script supports individual file comparisons, ensemble averages with uncertainty bands, percent difference calculations, seasonal analysis, and statistical significance testing.</p>
<p>This script is part of the <a href="https://github.com/philipmyint/e3sm--gcam_analysis">e3sm--gcam_analysis</a> repository, which provides tools for analyzing coupled E3SM-GCAM simulation outputs.</p>

<hr>

<h2>Table of Contents</h2>
<div class="toc">
<ul>
    <li><a href="#features">Features</a></li>
    <li><a href="#requirements">Requirements</a></li>
    <li><a href="#quick-start">Quick Start</a></li>
    <li><a href="#input-file-format">Input File Format</a></li>
    <li><a href="#configuration-parameters">Configuration Parameters</a></li>
    <li><a href="#output-files-format">Output Files Format</a></li>
    <li><a href="#plot-types">Plot Types</a></li>
    <li><a href="#examples">Examples</a></li>
    <li><a href="#troubleshooting">Troubleshooting</a></li>
    <li><a href="#references">References</a></li>
</ul>
</div>

<hr>

<h2 id="features">Features</h2>
<div class="feature-list">
    <div class="feature-item"><strong>Multiple Plot Types:</strong> Individual time series, ensemble averages with uncertainty bands</div>
    <div class="feature-item"><strong>Percent Difference:</strong> Compare scenarios relative to a control/reference</div>
    <div class="feature-item"><strong>Seasonal Analysis:</strong> Include seasonal averages (MAM, JJA, SON, DJF)</div>
    <div class="feature-item"><strong>Monthly Time Series:</strong> Generate monthly climatology plots</div>
    <div class="feature-item"><strong>Statistical Testing:</strong> Automatic t-tests with significance markers</div>
    <div class="feature-item"><strong>Flexible Configuration:</strong> Per-variable customization</div>
    <div class="feature-item"><strong>Parallel Processing:</strong> Multi-core support for speed</div>
    <div class="feature-item"><strong>Publication Quality:</strong> LaTeX support, customizable styling</div>
</div>

<hr>

<h2 id="requirements">Requirements</h2>
<h3>Python Dependencies</h3>
<pre><code>matplotlib
numpy
pandas
scipy</code></pre>

<h3>Additional Files</h3>
<p>The script requires these utility modules from the repository:</p>
<ul>
    <li><code>utility_constants.py</code></li>
    <li><code>utility_dataframes.py</code></li>
    <li><code>utility_functions.py</code></li>
    <li><code>utility_plots.py</code></li>
</ul>

<hr>

<h2 id="quick-start">Quick Start</h2>
<h3>Basic Usage</h3>
<pre><code>python e3sm_plot_time_series.py path/to/config.json</code></pre>

<h3>Multiple Configuration Files</h3>
<pre><code>python e3sm_plot_time_series.py config1.json config2.json config3.json</code></pre>

<h3>Minimal Configuration Example</h3>
<pre><code>[
    {
        "output_files": ["control.dat", "experiment.dat"],
        "output_labels": ["Control", "Experiment"],
        "plot_directory": "./plots/"
    }
]</code></pre>

<hr>

<h2 id="input-file-format">Input File Format</h2>
<h3>Data File Structure</h3>
<p>The script expects data files (<code>.dat</code> or similar) with the following structure:</p>
<table>
    <tr><th>Year</th><th>Month</th><th>Variable1 (units)</th><th>Variable2 (units)</th><th>...</th></tr>
    <tr><td>2015</td><td>1</td><td>410.5</td><td>0.025</td><td>...</td></tr>
    <tr><td>2015</td><td>2</td><td>411.2</td><td>0.031</td><td>...</td></tr>
</table>

<hr>

<h2 id="configuration-parameters">Configuration Parameters</h2>

<h3>Data Selection Parameters</h3>
<table>
    <tr><th>Parameter</th><th>Type</th><th>Required</th><th>Default</th><th>Possible Values</th><th>Description</th></tr>
    <tr><td><code>output_files</code></td><td>string/list/nested list</td><td><strong>Yes</strong></td><td>-</td><td>Valid file path(s)</td><td>Input data file(s) to plot</td></tr>
    <tr><td><code>output_labels</code></td><td>list</td><td>No</td><td>File names</td><td>List of strings</td><td>Labels for legend</td></tr>
    <tr><td><code>variables</code></td><td>list or string</td><td>No</td><td>All variables</td><td>Variable names or <code>"all"</code></td><td>Variables to plot</td></tr>
    <tr><td><code>start_year</code></td><td>integer</td><td>No</td><td><code>2015</code></td><td>Any year</td><td>First year to include</td></tr>
    <tr><td><code>end_year</code></td><td>integer</td><td>No</td><td><code>2100</code></td><td>Any year</td><td>Last year to include</td></tr>
    <tr><td><code>multiplier</code></td><td>number</td><td>No</td><td><code>1</code></td><td>Any number</td><td>Multiplier for unit conversion</td></tr>
</table>

<h3>Plot Type Parameters</h3>
<table>
    <tr><th>Parameter</th><th>Type</th><th>Required</th><th>Default</th><th>Possible Values</th><th>Description</th></tr>
    <tr><td><code>plot_type</code></td><td>string</td><td>No</td><td><code>"ensemble"</code></td><td><code>"ensemble"</code>, <code>"individual"</code></td><td>Type of plot</td></tr>
    <tr><td><code>plot_percent_difference</code></td><td>boolean</td><td>No</td><td><code>false</code></td><td><code>true</code>, <code>false</code></td><td>Calculate percent difference</td></tr>
    <tr><td><code>notify_output_files_transposed</code></td><td>boolean</td><td>No</td><td><code>false</code></td><td><code>true</code>, <code>false</code></td><td>Print message when files transposed</td></tr>
</table>

<h3>Output Parameters</h3>
<table>
    <tr><th>Parameter</th><th>Type</th><th>Required</th><th>Default</th><th>Possible Values</th><th>Description</th></tr>
    <tr><td><code>plot_directory</code></td><td>string</td><td>No</td><td><code>"./"</code></td><td>Valid directory path</td><td>Output directory</td></tr>
    <tr><td><code>plot_name</code></td><td>string or dict</td><td>No</td><td><code>"time_series_[variable]"</code></td><td>Filename</td><td>Output plot name</td></tr>
    <tr><td><code>produce_png</code></td><td>boolean</td><td>No</td><td><code>false</code></td><td><code>true</code>, <code>false</code></td><td>PNG instead of PDF</td></tr>
</table>

<h3>Axis Parameters</h3>
<table>
    <tr><th>Parameter</th><th>Type</th><th>Required</th><th>Default</th><th>Possible Values</th><th>Description</th></tr>
    <tr><td><code>x_limits</code></td><td>list or dict</td><td>No</td><td>Auto</td><td><code>[min, max]</code></td><td>X-axis limits</td></tr>
    <tr><td><code>y_limits</code></td><td>list or dict</td><td>No</td><td>Auto</td><td><code>[min, max]</code></td><td>Y-axis limits</td></tr>
    <tr><td><code>x_scale</code></td><td>string or dict</td><td>No</td><td><code>"linear"</code></td><td><code>"linear"</code>, <code>"log"</code></td><td>X-axis scale</td></tr>
    <tr><td><code>y_scale</code></td><td>string or dict</td><td>No</td><td><code>"linear"</code></td><td><code>"linear"</code>, <code>"log"</code></td><td>Y-axis scale</td></tr>
    <tr><td><code>y_label</code></td><td>string or dict</td><td>No</td><td>Column header</td><td>Any string</td><td>Y-axis label</td></tr>
</table>

<h3>Figure Parameters</h3>
<table>
    <tr><th>Parameter</th><th>Type</th><th>Required</th><th>Default</th><th>Description</th></tr>
    <tr><td><code>width</code></td><td>number</td><td>No</td><td><code>10</code></td><td>Figure width (inches)</td></tr>
    <tr><td><code>height</code></td><td>number</td><td>No</td><td><code>8</code></td><td>Figure height (inches)</td></tr>
    <tr><td><code>linewidth</code></td><td>number</td><td>No</td><td><code>2</code></td><td>Line thickness</td></tr>
    <tr><td><code>legend_on</code></td><td>boolean</td><td>No</td><td><code>true</code></td><td>Show legend</td></tr>
    <tr><td><code>use_latex</code></td><td>boolean</td><td>No</td><td><code>false</code></td><td>Use LaTeX rendering</td></tr>
</table>

<h3>Error Bar Parameters</h3>
<table>
    <tr><th>Parameter</th><th>Type</th><th>Required</th><th>Default</th><th>Description</th></tr>
    <tr><td><code>std_annual_multiplier</code></td><td>number or null</td><td>No</td><td><code>1</code></td><td>Multiplier for annual error bands</td></tr>
    <tr><td><code>std_monthly_multiplier</code></td><td>number or null</td><td>No</td><td><code>1</code></td><td>Multiplier for monthly error bands</td></tr>
    <tr><td><code>std_seasons_multiplier</code></td><td>number or null</td><td>No</td><td><code>null</code></td><td>Multiplier for seasonal error bands</td></tr>
    <tr><td><code>error_bars_alpha</code></td><td>number</td><td>No</td><td><code>0.2</code></td><td>Error band opacity (0-1)</td></tr>
</table>

<h3>Statistical Testing Parameters</h3>
<table>
    <tr><th>Parameter</th><th>Type</th><th>Required</th><th>Default</th><th>Description</th></tr>
    <tr><td><code>p_value_threshold</code></td><td>number</td><td>No</td><td><code>0.05</code></td><td>Significance threshold</td></tr>
    <tr><td><code>p_value_marker</code></td><td>string</td><td>No</td><td><code>"o"</code></td><td>Marker for significant points</td></tr>
    <tr><td><code>p_value_marker_size</code></td><td>number</td><td>No</td><td><code>6</code></td><td>Size of significance markers</td></tr>
    <tr><td><code>p_value_file</code></td><td>string</td><td>No</td><td><code>"p_values.dat"</code></td><td>File for p-value results</td></tr>
</table>

<h3>Seasonal Parameters</h3>
<table>
    <tr><th>Parameter</th><th>Type</th><th>Required</th><th>Default</th><th>Description</th></tr>
    <tr><td><code>include_seasons</code></td><td>dict</td><td>No</td><td>All <code>false</code></td><td>Add seasonal lines to annual plot</td></tr>
    <tr><td><code>seasons_to_plot_separately</code></td><td>dict</td><td>No</td><td>All <code>false</code></td><td>Create separate seasonal plot</td></tr>
</table>

<h3>Monthly Time Series Parameters</h3>
<table>
    <tr><th>Parameter</th><th>Type</th><th>Required</th><th>Default</th><th>Description</th></tr>
    <tr><td><code>monthly_time_series_plot</code></td><td>boolean or dict</td><td>No</td><td><code>false</code></td><td>Generate monthly plot</td></tr>
    <tr><td><code>monthly_time_series_start_year</code></td><td>integer</td><td>No</td><td><code>2071</code></td><td>Start year for monthly averaging</td></tr>
    <tr><td><code>monthly_time_series_end_year</code></td><td>integer</td><td>No</td><td><code>2090</code></td><td>End year for monthly averaging</td></tr>
    <tr><td><code>monthly_aggregation_type</code></td><td>string or dict</td><td>No</td><td><code>"mean"</code></td><td>How to aggregate (<code>"mean"</code> or <code>"sum"</code>)</td></tr>
</table>

<hr>

<h2 id="output-files-format">Output Files Format</h2>

<h3>Format 1: Single File</h3>
<pre><code>"output_files": "path/to/file.dat"</code></pre>

<h3>Format 2: Multiple Individual Files</h3>
<pre><code>"output_files": ["control.dat", "experiment1.dat", "experiment2.dat"]</code></pre>

<h3>Format 3: Ensemble Files (Organized by File Set - Recommended)</h3>
<pre><code>"output_files": [
    ["control.dat", "control_2.dat", "control_3.dat"],
    ["experiment.dat", "experiment_2.dat", "experiment_3.dat"]
],
"output_labels": ["Control", "Experiment"]</code></pre>
<p>Each inner list contains all ensemble members for one scenario.</p>

<h3>Format 4: Ensemble Files (Organized by Ensemble Member - Alternative)</h3>
<pre><code>"output_files": [
    ["control.dat", "experiment.dat"],
    ["control_2.dat", "experiment_2.dat"],
    ["control_3.dat", "experiment_3.dat"]
],
"output_labels": ["Control", "Experiment"]</code></pre>
<p>The script automatically transposes this format using <code>transpose_scenarios_if_needed()</code> in <code>utility_functions.py</code>.</p>

<div class="note">
<strong>Note:</strong> Format 3 is recommended as it's more intuitive.
</div>

<hr>

<h2 id="plot-types">Plot Types</h2>

<h3>Individual Plots (<code>plot_type: "individual"</code>)</h3>
<p>Each output file is plotted as a separate line.</p>

<h3>Ensemble Plots (<code>plot_type: "ensemble"</code>)</h3>
<p>Files are grouped into sets, and mean Â± standard deviation is calculated for each set. Statistical t-tests are performed between groups.</p>

<hr>

<h2 id="examples">Examples</h2>

<div class="example">
<h4>Example 1: Individual Plots</h4>
<pre><code>{
    "output_files": ["control.dat", "full_feedback.dat", "ag_scaling.dat", "carbon_scaling.dat"],
    "output_labels": ["Control", "Full feedback", "Ag scaling", "Carbon scaling"],
    "plot_directory": "./plots/individual",
    "y_label": {"ZCO2": "CO$_2$ concentration (ppm)"},
    "x_limits": {"ZCO2": [2015, 2100]},
    "y_limits": {"ZCO2": [400, 700]},
    "use_latex": true,
    "include_seasons": {"ZCO2": {"MAM": false, "JJA": true, "SON": false, "DJF": true}},
    "monthly_time_series_plot": {"ZCO2": true}
}</code></pre>
</div>

<div class="example">
<h4>Example 2: Percent Difference</h4>
<pre><code>{
    "output_files": ["control.dat", "full_feedback.dat", "ag_scaling.dat"],
    "output_labels": ["Control", "Full feedback", "Ag scaling"],
    "plot_directory": "./plots/percent_difference",
    "plot_percent_difference": true,
    "y_limits": {"ZCO2": [-10, 10]},
    "use_latex": true
}</code></pre>
</div>

<div class="example">
<h4>Example 3: Ensemble Plots</h4>
<pre><code>{
    "output_files": [
        ["control.dat", "control_2.dat", "control_3.dat", "control_4.dat", "control_5.dat"],
        ["full_feedback.dat", "full_feedback_2.dat", "full_feedback_3.dat", "full_feedback_4.dat", "full_feedback_5.dat"]
    ],
    "output_labels": ["Control", "Full feedback"],
    "plot_directory": "./plots/ensemble",
    "use_latex": true
}</code></pre>
</div>

<div class="example">
<h4>Example 4: Individual Lines from Ensemble Data</h4>
<pre><code>{
    "output_files": [
        ["control.dat", "control_2.dat", "control_3.dat"],
        ["full_feedback.dat", "full_feedback_2.dat", "full_feedback_3.dat"]
    ],
    "output_labels": ["Control", "Full feedback"],
    "plot_type": "individual",
    "plot_directory": "./plots/individual_not_grouped"
}</code></pre>
</div>

<hr>

<h2 id="troubleshooting">Troubleshooting</h2>

<div class="warning">
<h4>Issue: LaTeX Errors</h4>
<p><strong>Solution:</strong> Set <code>"use_latex": false</code> or install LaTeX.</p>
</div>

<div class="warning">
<h4>Issue: File Not Found</h4>
<p><strong>Solution:</strong> Check file paths are correct.</p>
</div>

<div class="warning">
<h4>Issue: Missing Variables</h4>
<p><strong>Solution:</strong> Verify variable names match column headers.</p>
</div>

<hr>

<h2 id="references">References</h2>
<ul>
    <li>DiVittorio et al. (2025). "E3SM-GCAM coupling methodology and applications." <em>JAMES</em>. <a href="https://agupubs.onlinelibrary.wiley.com/doi/full/10.1029/2024MS004806">DOI: 10.1029/2024MS004806</a></li>
    <li>GitHub: <a href="https://github.com/philipmyint/e3sm--gcam_analysis">https://github.com/philipmyint/e3sm--gcam_analysis</a></li>
    <li>E3SM Project: <a href="https://e3sm.org/">https://e3sm.org/</a></li>
</ul>

<hr>

<h2>Contact</h2>
<p><strong>Philip Myint:</strong> <a href="mailto:myint1@llnl.gov">myint1@llnl.gov</a><br>
<strong>Dalei Hao:</strong> <a href="mailto:dalei.hao@pnnl.gov">dalei.hao@pnnl.gov</a></p>

</body>
</html>
